#include <stdio.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <unistd.h>
#include <string.h>
#include <sys/wait.h>

struct msg_buffer {
    long mtype;
    char mtext[100];
};

int main() {
    key_t key = ftok("msgfile", 65);          // Generate key
    int msgid = msgget(key, 0666 | IPC_CREAT);

    if (msgid < 0) {
        perror("msgget error");
        return 1;
    }

    pid_t pid = fork();

    if (pid < 0) {
        perror("fork error");
        return 1;
    }

    if (pid > 0) {
        struct msg_buffer msg;
        msg.mtype = 1;
        strcpy(msg.mtext, "Hello from parent via message queue!");

        if (msgsnd(msgid, &msg, sizeof(msg.mtext), 0) == -1) {
            perror("msgsnd error");
            return 1;
        }

        printf("Parent (Sender): Message sent to queue.\n");

        wait(NULL); // Wait for child

        // Remove message queue
        msgctl(msgid, IPC_RMID, NULL);
    }

    else {
        sleep(1); // Ensure parent sends first

        struct msg_buffer msg;

        if (msgrcv(msgid, &msg, sizeof(msg.mtext), 1, 0) == -1) {
            perror("msgrcv error");
            return 1;
        }

        printf("Child (Receiver): Message received: %s\n", msg.mtext);
    }

    return 0;
}
